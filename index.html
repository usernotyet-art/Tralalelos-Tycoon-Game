<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tralalelo's Tycoon - Con Personaje Din√°mico</title>
    <style>
        /* Estilos generales */
        body {
            font-family: 'Courier New', monospace;
            background-color: #1c1c1c; 
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }
        h1 {
            color: #ff4500;
            text-align: center;
            grid-column: 1 / 3;
            margin-bottom: 20px;
        }
        
        /* Paneles */
        .panel {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.3);
            margin-bottom: 20px;
        }
        
        /* Panel de Estad√≠sticas */
        .stats-panel .stat-item {
            padding: 10px 0;
            border-bottom: 1px dashed #444;
            font-size: 1.1em;
        }
        .stats-panel span {
            float: right;
            font-weight: bold;
            color: #ffff00; 
        }
        .stats-panel #stat-lawsuits,
        .stats-panel #stat-cordura { 
             color: red; 
             cursor: pointer; 
             text-decoration: underline;
        }

        /* Log y Botones */
        .log-panel { 
            grid-column: 1 / 2; 
            display: flex; 
            flex-direction: column;
        }
        #log-feed-wrapper {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            align-items: flex-start;
        }
        #log-feed { 
            height: 200px; 
            overflow-y: scroll; 
            background-color: #111; 
            padding: 10px; 
            border-radius: 5px; 
            font-size: 0.9em; 
            flex-grow: 1; 
        }
        #next-day-btn { width: 100%; padding: 15px; font-size: 1.3em; background-color: #ff4500; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        #next-day-btn:hover:not(:disabled) { background-color: #cc3700; }
        #next-day-btn:disabled { background-color: #555; cursor: not-allowed; }

        /* Estilos de Tienda */
        .item-card {
            background-color: #383838;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid #ff4500;
        }
        .item-card button {
            padding: 8px 15px;
            background-color: #ff4500;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .item-card button:hover {
            background-color: #cc3700;
        }
        .premium-item { border-left: 5px solid gold; }
        .trap-item { border-left: 5px solid purple; }
        .personal-item { border-left: 5px solid #00ffcc; }

        
        /* Estilos del M√°nager (Personaje de Cordura) */
        #manager-sprite {
            width: 150px;
            min-width: 150px;
            height: 200px;
            border: 3px solid #ff4500;
            border-radius: 8px;
            /* Placeholder para el personaje, simula un estilo pixelado */
            background-image: url('https://placehold.co/150x200/2ecc71/ffffff?text=Gerente+Normal');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            image-rendering: pixelated; 
            transition: border-color 0.5s, filter 0.5s;
            background-color: #444; 
        }
        
        /* Estados de Cordura del M√°nager (Cambio din√°mico de imagen/filtros) */
        .cordura-state-1 {
            /* Normal (100 - 76) */
            border-color: #2ecc71 !important; /* Verde */
            background-image: url('https://placehold.co/150x200/2ecc71/ffffff?text=Gerente+Feliz');
            filter: grayscale(0) brightness(1);
        }
        .cordura-state-2 {
            /* Preocupado (75 - 51) */
            border-color: #f39c12 !important; /* Amarillo */
            background-image: url('https://placehold.co/150x200/f39c12/000000?text=Gerente+Preocupado');
            filter: grayscale(0.2) brightness(0.9);
        }
        .cordura-state-3 {
            /* Estresado (50 - 26) */
            border-color: #e67e22 !important; /* Naranja */
            background-image: url('https://placehold.co/150x200/e67e22/ffffff?text=Gerente+ESTR√âS');
            filter: grayscale(0.5) brightness(0.8);
        }
        .cordura-state-4 {
            /* Al borde (25 - 1) */
            border-color: #e74c3c !important; /* Rojo */
            background-image: url('https://placehold.co/150x200/e74c3c/ffffff?text=Gerente+AL+BORDE');
            filter: hue-rotate(300deg) saturate(1.5);
        }
        .cordura-state-5 {
            /* Locura (0) */
            border-color: #8e44ad !important; /* P√∫rpura */
            background-image: url('https://placehold.co/150x200/8e44ad/ffffff?text=HOMBRE+MORADO');
            filter: contrast(2) brightness(0.5); /* Oscuro y siniestro */
        }
        
        /* M√≥dulos (se mantienen) */
        .game-over-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            color: white;
            z-index: 1000;
            text-align: center;
            padding-top: 20%;
            border: 5px solid #ff4500;
        }
        #lawsuit-module,
        #illness-module { 
            display: none; 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: #333; 
            border: 5px solid #ff4500; 
            padding: 30px; 
            z-index: 2000; 
            text-align: center; 
            box-shadow: 0 0 20px rgba(255, 69, 0, 0.5); 
            width: 300px; 
        }
        
    </style>
</head>
<body onload="setupGame()">

<div class="game-over-screen" id="game-over-screen">
    <h2 id="final-emoji"></h2>
    <h3 id="final-message"></h3>
    <p id="final-text"></p>
    <button id="restart-btn" onclick="reiniciarPartida()">COMENZAR DE NUEVO</button>
</div>

<!-- M√≥dulos de Interacci√≥n -->
<div id="lawsuit-module">
    <h2>‚öñÔ∏è MANEJO DE DEMANDA ‚öñÔ∏è</h2>
    <p>Tienes una demanda activa que requiere tu atenci√≥n.</p>
    <p>Opciones:</p>
    <button id="pay-settlement-btn">PAGAR ACUERDO ($20)</button> 
    <button id="counter-sue-btn">DEMANDAR POR DIFAMACI√ìN ($50)</button> 
    <p id="lawsuit-outcome" style="margin-top: 15px; font-weight: bold; color: yellow;"></p>
</div>

<div id="illness-module">
    <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ CRISIS FAMILIAR ü§í</h2>
    <p id="illness-message">Un miembro de tu familia se ha enfermado gravemente y necesita tratamiento inmediato.</p>
    <p style="font-weight: bold;">Costo de la factura: $<span id="illness-cost">0</span></p>
    <button id="pay-illness-btn">PAGAR FACTURA</button>
    <button id="ignore-illness-btn" style="background-color: #880000;">IGNORAR RIESGO (¬°PELIGRO!)</button>
    <p id="illness-outcome" style="margin-top: 15px; font-weight: bold; color: yellow;"></p>
</div>

<div class="container" id="game-container">
    <h1>Tralalelo's Tycoon | D√≠a <span id="stat-day-main">0</span> de 360</h1>
    
    <!-- Panel de Log y Acciones -->
    <div class="log-panel panel">
        <h2>Reporte de Noche y D√≠a</h2>
        <div id="log-feed-wrapper">
            <div id="manager-sprite"></div> 
            <div id="log-feed"></div>
        </div>
        <button id="next-day-btn">Avanzar al D√≠a 1</button>
    </div>

    <!-- Panel de Estad√≠sticas -->
    <div class="stats-panel panel">
        <h2>üìä Estad√≠sticas</h2>
        <div class="stat-item">D√≠a Actual: <span id="stat-day">0</span></div>
        <div class="stat-item">Dinero: <span id="stat-money">$2000.00</span></div>
        <div class="stat-item">Reputaci√≥n: <span id="stat-reputation">10%</span></div>
        <div class="stat-item">Riesgo de Noche: <span id="stat-risk">0%</span></div>
        <div class="stat-item" style="font-weight: bold; color: yellow;">Demandas Activas: <span id="stat-lawsuits">0</span></div>
        <div class="stat-item">Activos Comprados: <span id="stat-assets">0</span></div>
        <div class="stat-item">Patrocinios Activos: <span id="stat-sponsors">0</span></div>
        <div class="stat-item">Competencia (Rivalidad): <span id="stat-rivalry">10%</span></div>
        <div class="stat-item" style="font-weight: bold; color: #00ffcc;">Cordura: <span id="stat-cordura">100</span></div>
    </div>
    
    <!-- Panel de Finales Completados -->
    <div class="panel" style="grid-column: 2 / 3;">
        <h2>üèÜ Finales Completados (Total: 11)</h2>
        <ul id="final-list" class="final-list">
            <li>Final Mediocre (Sobrevive 360, 0 Activos): <span id="final-mediocre">‚ùå</span></li>
            <li>Final Bancarrota: <span id="final-bankrupt">‚ùå</span></li>
            <li>Final Victoria (Sobrevive 360, >0 Activos): <span id="final-win">‚ùå</span></li>
            <li style="color: purple;">Final Clausura (Demanda Perdida): <span id="final-closure">‚ùå</span></li>
            <li style="color: gold;">Final Maestro (360 d√≠as, Rep >90, Dinero >$10k): <span id="final-master">‚ùå</span></li>
            <li style="color: orange;">Final Arriesgado (360 d√≠as, Riesgo >75, Activos >5): <span id="final-risk_taker">‚ùå</span></li>
            <li style="color: blue;">Final Solitario (360 d√≠as, Rivalidad <10, 0 Sponsors): <span id="final-recluse">‚ùå</span></li>
            <li style="color: red;">Final Derrota Rival (360 d√≠as, Rivalidad >85): <span id="final-rival_defeat">‚ùå</span></li>
            <li style="color: limegreen;">Final Pacifista (360 d√≠as, 0 Demandas/Accidentes): <span id="final-pacifista">‚ùå</span></li>
            <li style="color: #ff00ff;">Final Inculpado (Animatr√≥nicos Desechados): <span id="final-inculpado">‚ùå</span></li>
            <li style="color: violet;">Final Hombre Morado (Cordura 0): <span id="final-purple_guy">‚ùå</span></li>
        </ul>
        <button onclick="reiniciarFinales()" style="margin-top: 15px; background: #600; color: white; border: none; padding: 5px;">Reiniciar Progreso de Finales</button>
    </div>

    <!-- Panel de Compras -->
    <div class="shop-panel panel">
        <h2>üõí Tienda (Fase de Compra - Cambia Diariamente)</h2>
        
        <h2>üßò Gastos Personales (Cordura)</h2>
        <div id="personal-shop-items"></div>
        
        <h2>üõ°Ô∏è Seguridad y Control (Permanente)</h2>
        <div id="persistent-shop-items"></div>
        
        <h2>Otros Art√≠culos (Rotaci√≥n Diaria)</h2>
        <div id="shop-items"></div>
        
        <h2>ü§ù Oportunidades de Patrocinio</h2>
        <div id="sponsor-items"></div>
    </div>
</div>

<script>
    const MAX_DAYS = 360;
    
    // --- ESTADO INICIAL DEL JUEGO ---
    let game = {
        dinero: 2000.00, 
        riesgo: 0,
        reputacion: 10,
        activos: 0,
        sponsors: 0,
        rivalry: 10,
        demandas_activas: 0,
        accidentes_historicos: 0, 
        dia: 0,
        gameOver: false,
        activosComprados: 0,
        cordura: 100, 
        illnessActive: false,
        illnessCost: 0, 
        
        hasGuard: false,
        hasPerrunas: false, 
        infiniteMoney: false, 
        hasPremiumAnimatronics: false, 
        
        premium_cooldown: 0, 
        h_cheat_used_today: false,
        
        finales: {
            mediocre: false,
            bankrupt: false,
            win: false,
            closure: false,
            master: false,
            risk_taker: false,
            recluse: false,
            rival_defeat: false,
            pacifista: false,
            inculpado: false, 
            purple_guy: false,
        },
        itemsComprados: {} 
    };

    // --- PAR√ÅMETROS DE GASTOS Y COSTOS ---
    const GASTO_FAMILIAR_MIN = 30;
    const GASTO_FAMILIAR_MAX = 100;
    const PROB_ENFERMEDAD = 20; 
    const COSTO_CURACION_BASE = 500;
    const PERDIDA_CORDURA_MUERTE = 20;
    const COSTO_ACUERDO = 20; 
    const COSTO_CONTRA_DEMANDA = 50; 
    const DIA_DEMANDA_ALTA = 20;
    const PROB_DEMANDA_ALTA = 70; 
    const H_CHEAT_AMOUNT = 10000; 

    // --- CAT√ÅLOGOS BASE ---
    const CORDURA_ITEMS = {
        'Cena de Lujo (Cordura)': { costo: 80, cordura_add: 10, rotativo: true },
        'Masaje Terap√©utico (Cordura)': { costo: 65, cordura_add: 8, rotativo: true },
        'Juegos de Mesa Familiar (Cordura)': { costo: 40, cordura_add: 5, rotativo: true },
        'Noche de Cine (Cordura)': { costo: 55, cordura_add: 6, rotativo: true },
    };

    const CATALOGO_BASE = { 
        'Mesa B√°sica': { costo: 100, reputacion_add: 5, riesgo_add: 0, rotativo: true },
        'Juego Arcade': { costo: 250, reputacion_add: 10, riesgo_add: 0, rotativo: true },
        'Animatr√≥nico Usado': { costo: 500, reputacion_add: 15, riesgo_add: 15, rotativo: true },
        'Sistema de Ventilaci√≥n': { costo: 150, reputacion_add: 0, riesgo_add: -5, rotativo: true },
        'Sistema de Alarma Anti-Fallo': { costo: 300, reputacion_add: 5, riesgo_add: -10, rotativo: true },
        'Iluminaci√≥n LED': { costo: 80, reputacion_add: 3, riesgo_add: 0, rotativo: true },
        'Contrato Legal B√°sico': { costo: 500, reputacion_add: 0, riesgo_add: -15, rotativo: true },
        'Fuente de Pizzas': { costo: 750, reputacion_add: 20, riesgo_add: 5, rotativo: true },
        'Animatr√≥nico Roto (Riesgo Extremo)': { costo: 50, reputacion_add: 1, riesgo_add: 30, rotativo: true },
        'Animatr√≥nicos Desechados': { costo: 2, reputacion_add: -10, riesgo_add: 50, rotativo: true, final_secreto: 'inculpado' },
        'Grupo de Animatr√≥nicos Premium': { costo: 20000, reputacion_add: 50, riesgo_add: 0, rotativo: false, premium: true },
    };
    
    const GUARDIA_SEGURIDAD = {
        key: 'Guardia de Seguridad', 
        costo: 600, 
        reputacion_add_per_day: 5, 
        riesgo_add: -10,
        win_chance_add: 10 
    };

    const HERMANAS_PERRUNAS = {
        key: 'Hermanas Perrunas',
        costo: 1500,
        legal_win_chance: 80, 
        cordura_boost_amount: 100,
        cordura_boost_days: 30
    };

    const SPONSORS_BASE = {
        'Soda Pop Co.': { costo: 1000, reputacion_req: 40, dinero_add: 50, riesgo_add: 5, text: "A√±ade ingresos pasivos y riesgo." },
        'Cables C.A. S.A.': { costo: 500, reputacion_req: 20, dinero_add: 30, riesgo_add: -10, text: "Bajo ingreso, reduce riesgo el√©ctrico." },
        'App de Delivery R√°pido': { costo: 2000, reputacion_req: 60, dinero_add: 150, riesgo_add: 15, text: "Grandes ingresos, pero mayor desgaste y riesgo." },
        'Unicornio de Juguetes': { costo: 200, reputacion_req: 10, dinero_add: 10, riesgo_add: 0, text: "Patrocinio estable y peque√±o." },
    };


    // --- Elementos DOM ---
    const doc = document; // Alias consistente para document
    const stats = {
        day: doc.getElementById('stat-day'),
        dayMain: doc.getElementById('stat-day-main'),
        money: doc.getElementById('stat-money'),
        reputation: doc.getElementById('stat-reputation'),
        risk: doc.getElementById('stat-risk'),
        lawsuits: doc.getElementById('stat-lawsuits'),
        assets: doc.getElementById('stat-assets'),
        sponsors: doc.getElementById('stat-sponsors'),
        rivalry: doc.getElementById('stat-rivalry'),
        cordura: doc.getElementById('stat-cordura'),
    };
    const logFeed = doc.getElementById('log-feed');
    const managerSprite = doc.getElementById('manager-sprite'); 
    const shopItemsDiv = doc.getElementById('shop-items');
    const persistentShopDiv = doc.getElementById('persistent-shop-items');
    const sponsorItemsDiv = doc.getElementById('sponsor-items');
    const personalShopDiv = doc.getElementById('personal-shop-items'); 
    const nextDayBtn = doc.getElementById('next-day-btn');
    const gameOverScreen = doc.getElementById('game-over-screen');
    const lawsuitModule = doc.getElementById('lawsuit-module');
    const illnessModule = doc.getElementById('illness-module');
    
    // Configuraci√≥n de botones de m√≥dulo 
    doc.getElementById('counter-sue-btn').textContent = `DEMANDAR POR DIFAMACI√ìN ($${COSTO_CONTRA_DEMANDA})`;
    doc.getElementById('pay-settlement-btn').textContent = `PAGAR ACUERDO ($${COSTO_ACUERDO})`;


    // --- UTILITIES ---

    function randomSelect(arr, min, max) {
        if (!arr || arr.length === 0) return [];
        const count = Math.floor(Math.random() * (max - min + 1)) + min;
        // Shuffle and slice to select 'count' random elements
        const shuffled = [...arr].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, count);
    }
    
    function addLog(message, type = '') {
        const p = doc.createElement('p');
        p.className = type;
        p.textContent = `[D${game.dia}] ${message}`;
        logFeed.prepend(p);
    }

    // --- Funciones de Guardado y UI ---
    
    function loadFinals() {
        const savedFinals = localStorage.getItem('tralaleloFinals');
        if (savedFinals) {
            try {
                const loadedFinals = JSON.parse(savedFinals);
                Object.keys(game.finales).forEach(key => {
                    if (loadedFinals[key] !== undefined) {
                        game.finales[key] = loadedFinals[key];
                    }
                });
            } catch (e) {
                console.error("Error al cargar finales de localStorage:", e);
            }
        }
        updateFinalsUI();
    }

    function updateFinalsUI() {
        Object.keys(game.finales).forEach(key => {
            const element = doc.getElementById(`final-${key}`);
            if (element) {
                element.textContent = game.finales[key] ? '‚úÖ' : '‚ùå';
            }
        });
    }

    function saveFinal(finalKey) {
        if (!game.finales[finalKey]) {
            game.finales[finalKey] = true;
            localStorage.setItem('tralaleloFinals', JSON.stringify(game.finales));
            updateFinalsUI(); 
        }
    }

    function reiniciarFinales() {
        if (confirm("¬øEst√°s seguro que quieres borrar todo tu progreso de finales completados?")) {
            localStorage.removeItem('tralaleloFinals');
            Object.keys(game.finales).forEach(key => game.finales[key] = false);
            updateFinalsUI();
            window.location.reload(); 
        }
    }

    function checkInfiniteMode() {
        // El modo infinito requiere ambos finales
        if (game.finales.mediocre && game.finales.win) {
            game.infiniteMoney = true;
            addLog("MODO INFINITO DESBLOQUEADO: ¬°Dinero Infinito Activo!", 'alert-success');
        }
    }


    // --- Funci√≥n de Actualizaci√≥n del Personaje ---

    function updateManagerSprite() {
        let stateClass = '';
        managerSprite.className = ''; // Limpia clases anteriores
        
        // El personaje se muestra en base a la cordura
        if (game.cordura >= 76) {
            stateClass = 'cordura-state-1'; // Normal/Feliz
        } else if (game.cordura >= 51) {
            stateClass = 'cordura-state-2'; // Preocupado
        } else if (game.cordura >= 26) { // Ajuste del rango para ser m√°s progresivo
            stateClass = 'cordura-state-3'; // Estresado/Cansado
        } else if (game.cordura >= 1) {
            stateClass = 'cordura-state-4'; // Al borde/Enojo
        } else { // Cordura 0
            stateClass = 'cordura-state-5'; // Mirada Fr√≠a/Aterradora
        }
        
        managerSprite.classList.add(stateClass);
    }


    // --- Funciones de Utilidad del Juego ---

    function updateStats() {
        stats.day.textContent = game.dia;
        stats.dayMain.textContent = game.dia;
        
        if (game.infiniteMoney) {
            stats.money.textContent = `‚àû (Infinito)`;
            stats.money.style.color = '#00ff00';
            game.dinero = 99999999; 
        } else {
            stats.money.textContent = `$${game.dinero.toFixed(2)}`;
            stats.money.style.color = '#ffff00';
        }

        stats.reputation.textContent = `${game.reputacion}%`;
        stats.risk.textContent = `${game.riesgo}%`;
        stats.lawsuits.textContent = `${game.demandas_activas}`; 
        stats.assets.textContent = game.activos;
        stats.sponsors.textContent = game.sponsors;
        stats.rivalry.textContent = `${game.rivalry}%`;
        
        stats.cordura.textContent = `${game.cordura}`; 

        stats.risk.style.color = game.riesgo > 50 ? '#ff0000' : '#ffff00';
        stats.reputation.style.color = game.reputacion < 30 ? '#ff0000' : '#00ff00';
        stats.cordura.style.color = game.cordura < 30 ? '#ff0000' : '#00ffcc';

        // Solo permitir interacci√≥n si no hay m√≥dulos activos.
        stats.lawsuits.onclick = game.demandas_activas > 0 && !game.illnessActive ? openLawsuitModule : null; 
        stats.cordura.onclick = game.illnessActive && game.demandas_activas === 0 ? openIllnessModule : null; 
        
        updateManagerSprite(); 
    }
    
    function reiniciarPartida() {
        window.location.reload(); 
    }
    
    function adjustCordura(amount, reason) {
        if (game.infiniteMoney) return; 
        
        game.cordura = Math.min(100, Math.max(0, game.cordura + amount));
        
        if (amount < 0) {
            addLog(`CORDURA: Perdiste ${Math.abs(amount)} por ${reason}. Actual: ${game.cordura}`, 'alert-error');
        } else {
            addLog(`CORDURA: Ganaste ${amount} por ${reason}. Actual: ${game.cordura}`, 'alert-success');
        }
        
        updateStats(); 
        checkFinal(); 
    }


    // --- M√≥dulos Interactivos ---
    
    function closeModules() {
        lawsuitModule.style.display = 'none';
        illnessModule.style.display = 'none';
        doc.getElementById('lawsuit-outcome').textContent = '';
        doc.getElementById('illness-outcome').textContent = '';
        // No se re-habilita el bot√≥n aqu√≠, sino al final de nextDayHandler para asegurar que el avance contin√∫e.
    }

    function openLawsuitModule() {
        lawsuitModule.style.display = 'block';
        nextDayBtn.disabled = true;
    }

    function openIllnessModule() {
        game.illnessCost = COSTO_CURACION_BASE + (game.dia * 10) + (Math.random() * 100);
        doc.getElementById('illness-cost').textContent = game.illnessCost.toFixed(2);
        illnessModule.style.display = 'block';
        nextDayBtn.disabled = true;
    }
    
    // Handlers para el M√≥dulo de Demanda
    doc.getElementById('pay-settlement-btn').onclick = () => {
        if (game.dinero >= COSTO_ACUERDO) {
            game.dinero -= COSTO_ACUERDO;
            game.demandas_activas = Math.max(0, game.demandas_activas - 1);
            addLog(`DEMANDA: Pagaste el acuerdo por $${COSTO_ACUERDO}. ¬°Una menos!`, 'alert-success');
            closeModules();
            updateStats();
            nextDayHandler(); // Avanza el d√≠a
        } else {
            doc.getElementById('lawsuit-outcome').textContent = "¬°No tienes suficiente dinero para el acuerdo!";
        }
    };
    
    doc.getElementById('counter-sue-btn').onclick = () => {
        if (game.dinero >= COSTO_CONTRA_DEMANDA) {
            game.dinero -= COSTO_CONTRA_DEMANDA;
            
            let winChance = 20; 
            if (game.hasPerrunas) winChance = HERMANAS_PERRUNAS.legal_win_chance;
            if (game.hasGuard) winChance += GUARDIA_SEGURIDAD.win_chance_add;
            
            const result = Math.random() * 100;
            
            if (result < winChance) {
                // Ganar
                game.demandas_activas = Math.max(0, game.demandas_activas - 1);
                game.reputacion = Math.min(100, game.reputacion + 10);
                game.rivalry = Math.max(0, game.rivalry - 5);
                addLog(`DEMANDA: ¬°GANASTE! Reputaci√≥n +10 y rivalidad -5.`, 'alert-success');
                closeModules();
                updateStats();
                nextDayHandler();
            } else {
                // Perder
                game.demandas_activas = Math.max(0, game.demandas_activas - 1);
                game.reputacion = Math.max(0, game.reputacion - 20);
                game.dinero = 0; // Penalizaci√≥n severa
                addLog(`DEMANDA: ¬°PERDISTE! Reputaci√≥n -20 y PERDISTE TODO TU DINERO.`, 'alert-error');
                
                doc.getElementById('lawsuit-outcome').textContent = "¬°PERDISTE! Dinero CERO y Reputaci√≥n -20.";
                setTimeout(() => {
                    closeModules();
                    updateStats();
                    checkFinal(); 
                    if (!game.gameOver) nextDayHandler();
                }, 3000);
            }
        } else {
            doc.getElementById('lawsuit-outcome').textContent = "¬°No tienes suficiente para contra-demandar!";
        }
    };
    
    // Handlers para el M√≥dulo de Enfermedad
    doc.getElementById('pay-illness-btn').onclick = () => {
        if (game.dinero >= game.illnessCost) {
            game.dinero -= game.illnessCost;
            game.illnessActive = false;
            adjustCordura(5, "Resoluci√≥n de crisis familiar");
            addLog(`FAMILIA: Pagaste la factura de $${game.illnessCost.toFixed(2)}. Crisis resuelta. Cordura +5.`, 'alert-success');
            closeModules();
            updateStats();
            nextDayHandler();
        } else {
            doc.getElementById('illness-outcome').textContent = "¬°No tienes suficiente dinero para la factura m√©dica!";
        }
    };

    doc.getElementById('ignore-illness-btn').onclick = () => {
        const failureChance = Math.floor(Math.random() * 100);
        game.illnessActive = false;
        
        if (failureChance < PROB_ENFERMEDAD) {
            // Consecuencia fatal
            adjustCordura(-PERDIDA_CORDURA_MUERTE, "P√©rdida tr√°gica por ignorar enfermedad");
            game.reputacion = Math.max(0, game.reputacion - 15);
            addLog(`FAMILIA: ¬°HORROR! Tu familia sufri√≥ una p√©rdida. Cordura -${PERDIDA_CORDURA_MUERTE} y Reputaci√≥n -15.`, 'alert-error');
            doc.getElementById('illness-outcome').textContent = "¬°TRAGEDIA! Las consecuencias fueron fatales. Pierdes Cordura y Reputaci√≥n.";
            
        } else {
            // Consecuencia menor
            adjustCordura(-5, "Ansiedad por ignorar enfermedad");
            addLog("FAMILIA: La situaci√≥n es estable, pero el estr√©s de ignorarla te cost√≥ Cordura -5.", 'alert-warning');
            doc.getElementById('illness-outcome').textContent = "¬°Te salvaste por poco! Pero la ansiedad te estres√≥.";
        }
        
        setTimeout(() => {
            closeModules();
            updateStats();
            checkFinal(); 
            if (!game.gameOver) nextDayHandler();
        }, 3000);
    };

    // --- L√ìGICA DE COMPRA ---

    function faseCompra(itemKey, type) {
        
        let data;
        
        if (type === 'guard') {
            data = GUARDIA_SEGURIDAD;
        } else if (type === 'perrunas') {
            data = HERMANAS_PERRUNAS;
        } else if (type === 'personal') {
            data = CORDURA_ITEMS[itemKey];
        } else if (type === 'sponsor') {
            data = SPONSORS_BASE[itemKey];
        } else { // 'shop'
            data = CATALOGO_BASE[itemKey];
        }

        if (!data) {
             addLog(`ERROR: No se encontr√≥ la data para ${itemKey} (Tipo: ${type}).`, 'alert-error');
             return;
        }

        const costo = data.costo;
        
        if (!game.infiniteMoney && game.dinero < costo) {
            addLog(`ERROR: Dinero insuficiente ($${costo}) para ${itemKey}.`, 'alert-error');
            return;
        }
        
        // --- L√≥gica de Compra ---
        if (type === 'guard') {
            if (!game.infiniteMoney) game.dinero -= costo;
            game.hasGuard = true;
            game.riesgo = Math.max(0, game.riesgo + data.riesgo_add);
            game.activos += 1;
            game.activosComprados += 1;
            addLog(`COMPRA: ¬°Contrataste un Guardia de Seguridad!`, 'alert-success');
        
        } else if (type === 'perrunas') {
            if (!game.infiniteMoney) game.dinero -= costo;
            game.hasPerrunas = true;
            game.activos += 1;
            game.activosComprados += 1;
            
            adjustCordura(data.cordura_boost_amount, "Hermanas Perrunas (Compra Inicial)");
            addLog(`COMPRA √âPICA: ¬°Adquiriste las Hermanas Perrunas! Cordura +${data.cordura_boost_amount}.`, 'alert-success');

        } else if (type === 'personal') {
            if (!game.infiniteMoney) game.dinero -= costo;
            adjustCordura(data.cordura_add, `Gasto personal en ${itemKey}`);
            game.itemsComprados[`personal_${itemKey}`] = game.dia; 
            addLog(`GASTO PERSONAL: ${itemKey} comprado. Cordura +${data.cordura_add}.`, 'alert-success');
        
        } else if (type === 'sponsor') {
            if (game.reputacion < data.reputacion_req) {
                addLog(`ERROR: Necesitas ${data.reputacion_req}% de reputaci√≥n para ${itemKey}.`, 'alert-error');
                return;
            }
            if (!game.infiniteMoney) game.dinero -= costo;
            game.reputacion = Math.min(100, game.reputacion + (data.reputacion_add || 0));
            game.riesgo = Math.max(0, game.riesgo + data.riesgo_add);
            game.sponsors += 1;
            game.dinero += data.dinero_add;
            addLog(`PATROCINIO: ¬°Contrato con ${itemKey}! Ingreso +$${data.dinero_add}.`, 'alert-success');
        
        } else if (data.final_secreto === 'inculpado') {
            if (!game.infiniteMoney) game.dinero -= costo;
            addLog(`¬°COMPRA DE RIESGO! Adquiriste ${itemKey}. ¬°Debes esconderlos r√°pido!`, 'alert-demand');
            mostrarFinal('üö®', 'FINAL INCULPADO: ¬°Los Animatr√≥nicos ten√≠an cuerpos! La polic√≠a te arrest√≥.', 'inculpado');
            return; 
        
        } else if (data.premium) {
             if (!game.infiniteMoney) game.dinero -= costo;
             
             if (!game.infiniteMoney && game.dinero < 0) {
                 const deficit = Math.abs(game.dinero);
                 game.dinero = 1000.00; 
                 adjustCordura(-10, "Deuda enorme por pr√©stamo de activos");
                 addLog(`üí∏ SALVACI√ìN: ¬°La inversi√≥n de $20,000 actu√≥ como garant√≠a! Obtuviste un pr√©stamo de $${deficit.toFixed(2)} que te deja en $1000.`, 'alert-warning');
             }
             
             game.reputacion = Math.min(100, game.reputacion + data.reputacion_add);
             game.riesgo = Math.max(0, game.riesgo + data.riesgo_add);
             game.activos += 1;
             game.activosComprados += 1;
             game.itemsComprados[itemKey] = true;
             game.hasPremiumAnimatronics = true; 
             addLog(`COMPRA √âPICA: ¬°Compraste ${itemKey}! Rep: +${data.reputacion_add}. ¬°$5000 diarios asegurados!`, 'alert-success');
             game.premium_cooldown = -1; 
        
        } else { // √çtems normales
            if (!game.infiniteMoney) game.dinero -= costo;
            game.reputacion = Math.min(100, game.reputacion + (data.reputacion_add || 0));
            game.riesgo = Math.max(0, game.riesgo + data.riesgo_add);
            game.activos += 1;
            game.activosComprados += 1;
            game.itemsComprados[itemKey] = true;
            addLog(`COMPRA: A√±adido ${itemKey}. Rep: +${data.reputacion_add || 0}.`, 'alert-success');
        }

        updateStats();
        setupShop();
    }


    // --- L√ìGICA DE TIENDA DIN√ÅMICA y ROTACI√ìN ---
    function setupShop() {
        shopItemsDiv.innerHTML = '';
        sponsorItemsDiv.innerHTML = '';
        persistentShopDiv.innerHTML = '';
        personalShopDiv.innerHTML = ''; 

        // 1. GASTOS PERSONALES (CORDURA)
        const allCorduraKeys = Object.keys(CORDURA_ITEMS);
        const dailyCorduraItems = randomSelect(allCorduraKeys, 1, 3); 
        
        let itemsAvailablePersonal = false;
        
        dailyCorduraItems.forEach(itemKey => {
            const data = CORDURA_ITEMS[itemKey];
            if (game.itemsComprados[`personal_${itemKey}`] !== game.dia) { 
                itemsAvailablePersonal = true;
                const card = doc.createElement('div');
                card.className = 'item-card personal-item';
                card.innerHTML = `
                    <div>
                        <strong>üßò ${itemKey}</strong> | Costo: $${data.costo} | Cordura: +${data.cordura_add}
                        <br><small style="color: #00ffcc; font-weight: bold;">Compra √önica Diaria</small>
                    </div>
                    <button onclick="faseCompra('${itemKey}', 'personal')">Comprar</button>
                `;
                personalShopDiv.appendChild(card);
            }
        });
        
        if (!itemsAvailablePersonal) {
            personalShopDiv.innerHTML = '<p style="color: #7f8c8d;">Recargaste tu cordura por hoy.</p>';
        }


        // 2. Seguridad y Control (Permanente)
        let itemsAvailableSecurity = false;

        // Hermanas Perrunas
        if (!game.hasPerrunas) {
            itemsAvailableSecurity = true;
            const data = HERMANAS_PERRUNAS;
            const card = doc.createElement('div');
            card.className = 'item-card perruna-card';
            card.innerHTML = `
                <div>
                    <strong>üê∂ Hermanas Perrunas (Parlanchinas)</strong><br>
                    Costo: $${data.costo} | Beneficio: **80% de chance de ganar juicios** + **Cordura +100 cada 30 d√≠as.**
                </div>
                <button onclick="faseCompra('${data.key}', 'perrunas')">ADQUIRIR</button>
            `;
            persistentShopDiv.appendChild(card);
        }

        // Guardia de Seguridad
        if (!game.hasGuard) {
            itemsAvailableSecurity = true;
            const data = GUARDIA_SEGURIDAD;
            const card = doc.createElement('div');
            card.className = 'item-card persistent-card';
            card.innerHTML = `
                <div>
                    <strong>üö® ${data.key} (Compra √önica)</strong><br>
                    Costo: $${data.costo} | Beneficio: Rep. Diaria +${data.reputacion_add_per_day} | Riesgo -10% | Chance Demanda +${data.win_chance_add}%
                </div>
                <button onclick="faseCompra('${data.key}', 'guard')">Contratar</button>
            `;
            persistentShopDiv.appendChild(card);
        }
        
        if (!itemsAvailableSecurity) {
            persistentShopDiv.innerHTML = '<p style="color: #ff9800; font-weight: bold;">üõ°Ô∏è Activos de seguridad permanentes adquiridos. (Guardia y Perrunas activas).</p>';
        }


        // 3. Art√≠culos de Rotaci√≥n Diaria (Activos de Negocio)
        const allRotativeKeys = Object.keys(CATALOGO_BASE).filter(key => CATALOGO_BASE[key].rotativo && !game.itemsComprados[key]);
        const dailyItems = randomSelect(allRotativeKeys, 1, 2);
        
        if (game.premium_cooldown === 0 && !game.itemsComprados['Grupo de Animatr√≥nicos Premium']) {
            dailyItems.push('Grupo de Animatr√≥nicos Premium');
        }
        
        if (dailyItems.length === 0) {
            shopItemsDiv.innerHTML = '<p style="color: #7f8c8d;">El inventario de art√≠culos √∫nicos se ha agotado por hoy.</p>';
        }


        dailyItems.forEach(itemKey => {
            const data = CATALOGO_BASE[itemKey];
            const card = doc.createElement('div');
            card.className = 'item-card';

            if (data.premium) {
                card.className += ' premium-item';
                card.innerHTML = `
                    <div>
                        <strong>ü§ñ ${itemKey}</strong> | Costo: $${data.costo} | Rep: +${data.reputacion_add} | Riesgo: ${data.riesgo_add}
                        <br><small style="color: gold; font-weight: bold;">¬°BONO DIARIO: +$5000! (Salvaci√≥n de Bancarrota por 1 d√≠a)</small>
                    </div>
                    <button onclick="faseCompra('${itemKey}', 'shop')">COMPRAR (EPIC)</button>
                `;
            } else if (data.final_secreto) {
                card.className += ' trap-item';
                card.innerHTML = `
                    <div>
                        <strong>üíÄ ${itemKey}</strong> | Costo: $${data.costo} | Rep: ${data.reputacion_add} | Riesgo: ${data.riesgo_add}
                        <br><small style="color: #ff4500;">¬°MUY BARATO!</small>
                    </div>
                    <button onclick="faseCompra('${itemKey}', 'shop')">COMPRAR YA</button>
                `;
            } 
            else {
                card.innerHTML = `
                    <div>
                        <strong>${itemKey}</strong> | Costo: $${data.costo} | Rep: +${data.reputacion_add || 0} | Riesgo: ${data.riesgo_add}
                    </div>
                    <button onclick="faseCompra('${itemKey}', 'shop')">Comprar</button>
                `;
            }
            shopItemsDiv.appendChild(card);
        });
        
        // 4. Patrocinios
        const allSponsorKeys = Object.keys(SPONSORS_BASE).filter(key => !game.itemsComprados[key] && game.reputacion >= SPONSORS_BASE[key].reputacion_req);
        const dailySponsors = randomSelect(allSponsorKeys, 0, 2);

        if (dailySponsors.length > 0) {
             dailySponsors.forEach(sponsorKey => {
                const data = SPONSORS_BASE[sponsorKey];
                const card = doc.createElement('div');
                card.className = 'item-card sponsor-item';
                card.innerHTML = `
                    <div>
                        <strong>ü§ù ${sponsorKey}</strong> | Costo: $${data.costo} | Rep. Req: ${data.reputacion_req}%
                        <br><small>Dinero Diario: +$${data.dinero_add}. ${data.text}</small>
                    </div>
                    <button onclick="faseCompra('${sponsorKey}', 'sponsor')">PATROCINAR</button>
                `;
                sponsorItemsDiv.appendChild(card);
            });
        } else {
             sponsorItemsDiv.innerHTML = '<p style="color: #7f8c8d;">No hay patrocinios disponibles hoy o tu reputaci√≥n es muy baja.</p>';
        }

        addLog(`INVENTARIO: ${allRotativeKeys.length} √≠tems √∫nicos restantes.`, 'alert-warning');
    }
    
    // --- FASES DEL JUEGO ---
    
    function faseDia() {
        // Ingresos base + sponsors
        let ingresos = Math.max(100, game.reputacion * 10);
        
        Object.keys(SPONSORS_BASE).forEach(key => {
            if (game.itemsComprados[key]) {
                ingresos += SPONSORS_BASE[key].dinero_add;
            }
        });
        
        // Bonus de Animatr√≥nicos Premium
        if (game.hasPremiumAnimatronics) {
            ingresos += 5000;
        }

        game.dinero += ingresos;
        addLog(`DIA: Ingresos del d√≠a: $${ingresos.toFixed(2)}.`, 'alert-success');
    }
    
    function faseNoche() {
        // Gasto familiar
        const gastoFamiliar = Math.floor(Math.random() * (GASTO_FAMILIAR_MAX - GASTO_FAMILIAR_MIN + 1)) + GASTO_FAMILIAR_MIN;
        game.dinero -= gastoFamiliar;
        addLog(`NOCHE: Gastos familiares fijos: -$${gastoFamiliar.toFixed(2)}.`, 'alert-warning');

        // P√©rdida de Cordura base
        adjustCordura(-1, "Estr√©s laboral diario");
        
        // Chequeo de Demandas
        const probBaseDemanda = game.riesgo * 0.5; // Base 50% del riesgo
        let probDemanda = probBaseDemanda;
        
        if (game.dia >= DIA_DEMANDA_ALTA && game.riesgo >= 30) {
             probDemanda = PROB_DEMANDA_ALTA;
        }

        if (Math.random() * 100 < probDemanda) {
            game.demandas_activas++;
            addLog(`¬°ALERTA DE RIESGO! Una nueva demanda activa. Tienes ${game.demandas_activas} en curso.`, 'alert-demand');
            
            // Si el riesgo es muy alto, cordura baja por p√°nico
            if (game.riesgo > 70) {
                adjustCordura(-5, "P√°nico por demanda en alto riesgo");
            }
        }
        
        // Chequeo de Enfermedad Familiar
        if (Math.random() * 100 < PROB_ENFERMEDAD) {
            game.illnessActive = true;
            addLog(`¬°CRISIS FAMILIAR! Alguien enferm√≥ gravemente. Debes pagar la factura antes de avanzar.`, 'alert-error');
            // openIllnessModule() se llama en nextDayHandler para bloquear
        }

        // Chequeo de Bancarrota
        if (!game.infiniteMoney && game.dinero < 0) {
             mostrarFinal('üíÄ', 'FINAL BANCARROTA: La pizzer√≠a no pudo pagar sus deudas. Cierre forzado.', 'bankrupt');
        }
        
        // Rivalidad y Reputaci√≥n
        game.rivalry = Math.min(100, game.rivalry + (game.activosComprados > 0 ? 1 : 0) - (game.reputacion > 50 ? 1 : 0));
        game.reputacion = Math.max(0, game.reputacion - Math.floor(game.rivalry / 10)); // La rivalidad reduce Reputaci√≥n
    }
    
    
    function mostrarFinal(emoji, message, finalKey) {
        if (game.gameOver) return;
        game.gameOver = true;
        
        saveFinal(finalKey);
        
        doc.getElementById('final-emoji').textContent = emoji;
        doc.getElementById('final-message').textContent = message;
        doc.getElementById('final-text').innerHTML = `
            D√≠as Sobrevividos: ${game.dia} / ${MAX_DAYS}<br>
            Dinero Final: $${game.dinero.toFixed(2)}<br>
            Reputaci√≥n: ${game.reputacion}%
        `;
        
        gameOverScreen.style.display = 'block';
        nextDayBtn.disabled = true;
    }

    function checkFinal() {
        if (game.gameOver) return true;
        
        if (game.cordura <= 0) {
            mostrarFinal('üü£', 'FINAL HOMBRE MORADO: La locura te consumi√≥. Ahora eres una amenaza m√°s que un gerente.', 'purple_guy');
            return true;
        }

        if (game.dia >= MAX_DAYS) {
            if (game.reputacion >= 90 && game.dinero >= 10000) {
                mostrarFinal('üëë', 'FINAL MAESTRO: Dominaste el riesgo y los negocios. ¬°Leyenda de las pizzer√≠as!', 'master');
            } else if (game.rivalry >= 85) {
                mostrarFinal('‚öîÔ∏è', 'FINAL DERROTA RIVAL: Eliminaste a la competencia. El nuevo l√≠der.', 'rival_defeat');
            } else if (game.riesgo >= 75 && game.activosComprados >= 5) {
                mostrarFinal('üé≤', 'FINAL ARRIESGADO: ¬°Sobreviviste contra todo pron√≥stico! Pura suerte.', 'risk_taker');
            } else if (game.rivalry <= 10 && game.sponsors === 0) {
                mostrarFinal('üßò', 'FINAL SOLITARIO: Mantuviste un perfil bajo. El ermita√±o del negocio.', 'recluse');
            } else if (game.demandas_activas === 0 && game.accidentes_historicos === 0) {
                mostrarFinal('‚ú®', 'FINAL PACIFISTA: Cero incidentes. Una gesti√≥n limpia e impecable.', 'pacifista');
            } else if (game.activosComprados > 0) {
                mostrarFinal('üåü', 'FINAL VICTORIA: Sobreviviste los 360 d√≠as con √©xito.', 'win');
            } else {
                mostrarFinal('üòî', 'FINAL MEDIOCRE: Apenas sobreviviste. Sin gloria, pero vivo.', 'mediocre');
            }
            return true;
        }
        return false;
    }
    
    function nextDayHandler() {
        if (game.gameOver) return;
        
        // Resetear el uso del truco 'H' cada d√≠a
        game.h_cheat_used_today = false; 

        // Los m√≥dulos bloquean el avance. Si est√°n activos, mostramos el m√≥dulo y salimos.
        if (game.illnessActive) {
            openIllnessModule();
            return;
        }
        
        if (game.demandas_activas > 0) {
            openLawsuitModule();
            return;
        }
        
        game.dia++;
        addLog("--- INICIANDO NUEVA RONDA ---");

        faseDia();
        faseNoche();
        
        // L√≥gica de cooldowns y mensajes se mantiene
        if (game.premium_cooldown > 0) game.premium_cooldown--;
        if (game.premium_cooldown === 0 && game.hasPremiumAnimatronics) {
            addLog("El efecto de los Animatr√≥nicos Premium termin√≥. ¬°Cuidado!", 'alert-warning');
            game.hasPremiumAnimatronics = false;
        }
        
        // L√≥gica de Hermanas Perrunas (Cordura cada 30 d√≠as)
        if (game.hasPerrunas && (game.dia % 30 === 0)) {
            const boost = HERMANAS_PERRUNAS.cordura_boost_amount;
            adjustCordura(boost, "Terapia de Hermanas Perrunas");
            addLog(`üê∂ Las Hermanas Perrunas te dieron una dosis de √°nimo. Cordura +${boost}.`, 'alert-success');
        }

        setupShop(); 
        updateStats();

        if (checkFinal()) {
            // Se maneja en mostrarFinal
        } else {
            nextDayBtn.textContent = `Avanzar al D√≠a ${game.dia + 1}`;
            // FIX CR√çTICO: Re-habilitamos el bot√≥n si el d√≠a avanz√≥ sin bloqueos.
            nextDayBtn.disabled = false; 
        }
        
        logFeed.scrollTop = 0;
    }

    // --- L√≥gica del Truco 'H' (Dinero de emergencia) ---
    function handleHCheat() {
        if (game.gameOver || game.infiniteMoney) return;
        if (game.h_cheat_used_today) {
            addLog("TRUCO: Ya usaste el dinero de emergencia hoy. Vuelve ma√±ana.", 'alert-warning');
            return;
        }
        
        game.dinero += H_CHEAT_AMOUNT;
        game.h_cheat_used_today = true;
        
        addLog(`TRUCO: ¬°Recibiste una inyecci√≥n de capital de emergencia de $${H_CHEAT_AMOUNT}!`, 'alert-success');
        
        // Peque√±a penalizaci√≥n de Cordura por depender de trucos
        adjustCordura(-3, "Dependencia de trucos y atajos"); 
        
        updateStats();
    }


    // --- INICIALIZACI√ìN ---
    
    function setupGame() {
        loadFinals();
        checkInfiniteMode(); 

        // 1. Aseguramos que las estad√≠sticas y el personaje se muestren
        updateStats(); 
        
        // 2. Aseguramos que la tienda cargue sus √≠tems
        setupShop();
        
        // 3. Adjuntamos el manejador del bot√≥n
        nextDayBtn.addEventListener('click', nextDayHandler);
        
        // Asignaci√≥n del evento keydown (Truco 'H')
        doc.addEventListener('keydown', (e) => {
            if ((e.key === 'h' || e.key === 'H') && !game.gameOver) {
                handleHCheat();
            }
        });
        
        if (game.dia === 0) {
            if (game.infiniteMoney) {
                addLog("MODO INFINITO ACTIVO: ¬°Felicidades! Los trucos est√°n desbloqueados.", 'alert-success');
            } else {
                addLog("Bienvenido a Tralalelo's Tycoon. ¬°Inicias con $2000! ¬°Contrata un Guardia de Seguridad cuanto antes! Consejo: Presiona 'H' una vez al d√≠a para un impulso de emergencia.", 'alert-warning');
            }
        }
    }
    
</script>

</body>
</html>
